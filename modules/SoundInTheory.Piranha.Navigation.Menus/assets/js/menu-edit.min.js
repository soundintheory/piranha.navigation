Vue.component("navigation-menu-item",{props:["item","menu","level"],inject:["root"],data:function(){return{isExpanded:!0,isNode:!0}},methods:{toggle:function(){this.isExpanded=!this.isExpanded},getProperty:function(e,t){for(var i=t.split(".").filter(e=>!!e);0<i.length&&(e=e[this.toCamelCase(i.shift())]););return e},toCamelCase:function(e){return e.charAt(0).toLowerCase()+e.slice(1)},isObject:function(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e},closest:function(e){let t=this;for(;t&&t.isNode;){if(e(t))return t;t=t.$parent}return null}},computed:{maxDepth:function(){return this.itemType?this.itemType.maxDepth:null},hasMaxDepth:function(){return!!this.itemType&&"number"==typeof this.itemType.maxDepth},canAddChildren:function(){var e=this.closest(e=>e.hasMaxDepth);return e?this.level<e.maxDepth+e.level:this.level<this.menu.settings.maxDepth||!this.menu.settings.maxDepth},hasChildren:function(){return this.item.children&&0<this.item.children.length},defaultTypeName:function(){return this.itemType?this.itemType.title:this.item.$typeId},defaultLabel:function(){return this.item.link&&this.item.link.text?this.item.link.text:this.item.text&&this.item.text.value?this.item.text.value:this.item.title&&this.item.title.value?this.item.title.value:""},itemType:function(){return this.root.availableItemTypes.find(e=>e.id===this.item.$typeId)},availableItemTypes:function(){let e=this.root.availableItemTypes.map(e=>e.id);return(e=this.itemType&&this.itemType.allowedChildren&&0<this.itemType.allowedChildren.length?this.itemType.allowedChildren:e).filter(t=>{var e=this.root.availableItemTypes.find(e=>e.id===t);return!!e&&!(0<e.maxLevel&&e.maxLevel<=this.level||e.allowedParents&&0<e.allowedParents.length&&!e.allowedParents.includes(this.item.$typeId))})}},template:'\n<li class="dd-item" :class="{ expanded: isExpanded || !hasChildren }" :data-id="item.id" :data-item-type="item.$typeId" :data-level="level">\n    <div class="nav-menu-item" :class="{ dimmed: item.isUnpublished || item.isScheduled }">\n        <div v-if="piranha.navigation.permissions.menus.editItems" class="handle dd-handle"><i class="fas fa-ellipsis-v"></i></div>\n        <div class="link">\n            <span class="actions" v-if="hasChildren">\n                <a v-if="isExpanded" v-on:click.prevent="toggle()" class="expand" href="#"><i class="fas fa-minus"></i></a>\n                <a v-else v-on:click.prevent="toggle()" class="expand" href="#"><i class="fas fa-plus"></i></a>\n            </span>\n            <a v-if="piranha.navigation.permissions.menus.editItems" href="#" v-on:click.prevent="piranha.navigation.menuedit.editItem(item)">\n                <dynamic-item-label v-if="!!itemType && !!itemType.listTitle" v-bind:template="itemType.listTitle" v-bind:item="item"></dynamic-item-label>\n                <span v-else>{{ defaultLabel }}</span>\n            </a>\n            <span v-else class="title">\n                <dynamic-item-label v-if="!!itemType && !!itemType.listTitle" v-bind:template="itemType.listTitle" v-bind:item="item"></dynamic-item-label>\n                <span v-else>{{ defaultLabel }}</span>\n            </span>\n        </div>\n        <div class="type d-none d-md-block">\n            <dynamic-item-label v-if="!!itemType && !!itemType.listType" v-bind:template="itemType.listType" v-bind:item="item"></dynamic-item-label>\n            <span v-else>{{ defaultTypeName }}</span>\n        </div>\n        <div class="item-actions">\n            <template v-if="piranha.navigation.permissions.menus.editItems">\n                <add-item-link v-if="canAddChildren" link-class="action" :position="{ parentId: item.id }" header="Add Child..." :available-types="availableItemTypes">\n                    <i class="fas fa-plus"></i>\n                </add-item-link>\n                <span v-else style="visibility:hidden;"><i class="fas fa-plus"></i></span>\n            </template>\n            <a v-if="piranha.navigation.permissions.menus.deleteItems" v-on:click.prevent="piranha.navigation.menuedit.removeItem(item.id)" class="action text-danger" href="#"><i class="fas fa-trash"></i></a>\n        </div>\n    </div>\n    <ol v-if="hasChildren" class="dd-list">\n        <navigation-menu-item v-for="child in item.children" v-bind:key="child.id" v-bind:item="child" v-bind:menu="menu" v-bind:level="(level || 0) + 1">\n        </navigation-menu-item>\n    </ol>\n</li>\n'}),Vue.component("dynamic-item-label",{data:function(){return{}},props:["template","item"],created(){this.$options.template=`<span>${this.template||""}</span>`},template:""}),Vue.component("add-item-link",{props:["availableTypes","position","wrapClass","linkClass","header"],inject:["root"],data:function(){return{}},computed:{types:function(){return this.availableTypes&&0<this.availableTypes.length?this.root.availableItemTypes.filter(e=>this.availableTypes.includes(e.id)):this.root.availableItemTypes}},template:'\n<div class="add-item dropdown" :class="wrapClass || \'\'" v-if="types.length > 0">\n    <a role="button" :class="linkClass || \'\'" href="#" data-toggle="dropdown">\n        <slot></slot>\n    </a>\n    <div class="dropdown-menu dropdown-menu-right">\n        <h6 class="dropdown-header" v-if="header">{{ header }}</h6>\n        <a class="dropdown-item" href="#" v-for="type in types" v-on:click.prevent="piranha.navigation.menuedit.addItem(type.id, position)">{{ type.title }}</a>\n    </div>\n</div>\n'}),piranha.navigation=piranha.navigation||{},piranha.navigation.menuedit=new Vue({el:"#menuedit",data:{loading:!0,menu:null,availableItemTypes:[],addSiteTitle:null,addToSiteId:null,addPageId:null,currentState:null},provide:function(){return{root:this}},methods:{load:function(e){return this.baseApiUrl=piranha.baseUrl+"manager/api/navigation/menus/"+e,fetch(this.baseApiUrl).then(e=>e.json()).then(e=>{e.menu&&this.setMenu(e.menu),e.availableMenuItemTypes&&(this.availableItemTypes=e.availableMenuItemTypes,piranha.navigation.linkmodal.setAvailableItemTypes(e.availableMenuItemTypes))}).catch(e=>{console.log("error:",e)})},reload:function(){this.menu&&this.menu.id&&this.load(this.menu.id)},removeItem:function(e){piranha.alert.open({title:piranha.resources.texts.delete,body:"Are you sure you want to delete this item?",confirmCss:"btn-danger",confirmIcon:"fas fa-trash",confirmText:piranha.resources.texts.delete,onConfirm:()=>{fetch(this.baseApiUrl+"/items/"+e,{method:"delete",headers:piranha.utils.antiForgeryHeaders()}).then(e=>e.json()).then(e=>{piranha.notifications.push(e),this.reload()}).catch(e=>{console.log("error:",e)})}})},bind:function(){$(".menu-container").each((e,t)=>{$(t).nestable({group:e,onDragStart:(e,t)=>{document.documentElement.classList.add("dd-dragging"),this.currentState=JSON.stringify($(e).nestable("serialize")),this.draggingItemType=this.availableItemTypes.find(e=>e.id===$(t).data("item-type"))},beforeDragStop:(e,t,i)=>{const n=this.getParentNode(i);i=parseInt(n.data("level"));if(this.draggingItemType&&n&&0<n.length){var a=this.availableItemTypes.find(e=>e.id===n.data("item-type"));if(this.draggingItemType.maxLevel<=i)return!1;if(this.draggingItemType.allowedParents&&0<this.draggingItemType.allowedParents.length&&!this.draggingItemType.allowedParents.includes(a.id))return!1;if(a.allowedChildren&&0<a.allowedChildren.length&&!a.allowedChildren.includes(this.draggingItemType.id))return!1}else if(this.draggingItemType&&(!n||0===n.length)&&this.draggingItemType.allowedParents&&0<this.draggingItemType.allowedParents.length&&!this.draggingItemType.allowedParents.includes("root"))return!1;document.documentElement.classList.remove("dd-dragging")},callback:(e,t)=>{document.documentElement.classList.remove("dd-dragging");e=$(e).nestable("serialize");JSON.stringify(e)!==this.currentState&&fetch(this.baseApiUrl+"/structure",{method:"post",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify({menu:{id:this.menu.id,items:e}})}).then(e=>e.json()).then(e=>{"success"===e.status.type?this.setMenu(e.menu):piranha.notifications.push(e.status)}).catch(e=>{console.log("error:",e)})}})})},addItem:function(e,t){piranha.navigation.linkmodal.open(e=>{fetch(this.baseApiUrl+"/items",{method:"post",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify({position:t,item:e})}).then(e=>e.json()).then(e=>{e.status&&(piranha.notifications.push(e.status),"success"===e.status.type)&&this.setMenu(e.menu)}).catch(e=>{console.log("error:",e)})},{$typeId:e})},editItem:function(t){piranha.navigation.linkmodal.open(e=>{Object.assign(t,e),fetch(this.baseApiUrl+"/items",{method:"post",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify({item:t})}).then(e=>e.json()).then(e=>{e.status&&(piranha.notifications.push(e.status),"success"===e.status.type)&&this.setMenu(e.menu)}).catch(e=>{console.log("error:",e)})},t)},setMenu:function(e){console.log("setMenu: ",e),this.menu&&($(".menu-container").nestable("destroy"),this.menu=null),Vue.nextTick(()=>{this.menu=e,Vue.nextTick(()=>{this.bind(),this.loading=!1})})},getParentNode:function(e){return $(e).parents("[data-item-type].dd-item").first()}},computed:{availableTypes:function(){return this.availableItemTypes.map(e=>e.id).filter(t=>{var e=this.availableItemTypes.find(e=>e.id===t);return!(!e||e.allowedParents&&0<e.allowedParents.length&&!e.allowedParents.includes("root"))})}},created:function(){}});