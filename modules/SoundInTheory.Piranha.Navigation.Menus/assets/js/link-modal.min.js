Vue.component("link-modal",{data:function(){return{callback:null,currentModel:{},availableMenuItemTypes:[],defaultTypeId:"Link"}},computed:{actionName:function(){return this.currentModel&&this.currentModel.id?"Edit":"Add"},typeName:function(){return this.itemType?this.itemType.title:"Menu Item"},typeId:function(){return this.currentModel.$typeId||this.defaultTypeId},itemType:function(){return this.typeId?this.availableMenuItemTypes.find(t=>t.id===this.typeId):null},fields:function(){return this.itemType&&this.itemType.fields||[]},defaultItemType:function(){return this.availableMenuItemTypes.find(t=>t.id===this.defaultTypeId)}},methods:{setAvailableItemTypes:function(t){t&&(this.availableMenuItemTypes=t)},save:function(){var t;this.callback&&(t=JSON.parse(JSON.stringify(this.currentModel)),console.log("SAVE: ",t),this.callback(t),this.callback=null),$(this.$refs.modal).modal("hide")},open:function(t,e){this.callback=e,this.setCurrentModel(t),$(this.$refs.modal).modal("show")},setCurrentModel:function(t){const e=t&&t.$typeId?t.$typeId:this.defaultType;var n=this.availableMenuItemTypes.find(t=>t.id===e)||this.defaultItemType;const l=t||{},i={$typeId:n?n.id:e};l.id&&(i.id=l.id),n&&n.fields.forEach(t=>{var e=this.toCamelCase(t.meta.name);i[e]=JSON.parse(JSON.stringify(l[e]||t.model)),delete i[e].$type}),this.currentModel=i,console.log("set current model: ",n.id,t,i)},getFieldModel:function(t){t=this.toCamelCase(t.meta.name);return this.currentModel[t]||{}},updateFieldValue:function(t,e){this.currentModel[t]=e},toCamelCase:function(t){return t.charAt(0).toLowerCase()+t.slice(1)}},template:'\n<div class="modal modal-panel fade" id="linkmodal" ref="modal">\n    <div class="modal-dialog modal-lg">\n        <div class="modal-content">\n            \x3c!-- Modal Header --\x3e\n            <div class="modal-header border-bottom-0">\n                <h5 class="modal-title"><i class="fas fa-link mr-1"></i> {{ actionName }} {{ typeName }}</h5>\n                <button type="button" class="close" aria-label="Close" data-dismiss="modal">\n                    <span aria-hidden="true">&times;</span>\n                </button>\n            </div>\n\n            \x3c!-- Modal Body --\x3e\n            <div class="modal-body bg-light" v-if="currentModel" ref="modalBody">\n\n                \x3c!-- Dynamic Field Rendering using Vue Dynamic Components --\x3e\n                <div v-for="field in fields" :key="field.id" class="form-group row">\n                    <label class="col-sm-2 col-form-label" :for="field.meta.uid">{{ field.meta.name }}</label>\n                    <div class="col-sm-10">\n                        <div class="field-body">\n                            <div :id="\'tb-\' + field.meta.uid" class="component-toolbar"></div>\n                            <component v-if="getFieldModel(field) != null"\n                                       :is="field.meta.component"\n                                       :uid="field.meta.uid"\n                                       :model="getFieldModel(field)"\n                                       :meta="field.meta"\n                                       :toolbar="\'tb-\' + field.meta.uid">\n                            </component>\n                        </div>\n                        <div v-if="field.meta.description != null" v-html="field.meta.description" class="field-description small text-muted"></div>\n                    </div>\n                </div>\n\n            </div>\n            <div class="modal-footer">\n                <button class="btn btn-primary" v-on:click="save()">Save</button>\n                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>\n            </div>\n        </div>\n    </div>\n</div>\n'}),Vue.component("menu-link-field",{props:{uid:String,model:Object},data:function(){return{currentModel:this.model||this.getLinkDefaults()}},mounted:function(){this.initSelect2(10)},computed:{linkTargetBlank:{get:function(){return!(!this.currentModel||!this.currentModel.attributes)&&"_blank"===this.currentModel.attributes.target},set:function(t){this.currentModel.attributes||(this.currentModel.attributes={}),this.currentModel.attributes.target=t?"_blank":null,this.emitUpdate()}},linkNofollow:{get:function(){return!(!this.currentModel||!this.currentModel.attributes)&&"nofollow"===this.currentModel.attributes.rel},set:function(t){this.currentModel.attributes||(this.currentModel.attributes={}),this.currentModel.attributes.rel=t?"nofollow":null,this.emitUpdate()}},linkNoopener:{get:function(){return!(!this.currentModel||!this.currentModel.attributes)&&"noopener"===this.currentModel.attributes.rel},set:function(t){this.currentModel.attributes||(this.currentModel.attributes={}),this.currentModel.attributes.rel=t?"noopener":null,this.emitUpdate()}},canUseContentTitle:function(){return this.currentModel&&this.currentModel.contentLink&&("Page"===this.currentModel.type||"Post"===this.currentModel.type)}},watch:{"currentModel.text":function(){this.emitUpdate()},"currentModel.url":function(){this.emitUpdate()},"currentModel.useContentTitle":function(t){t&&this.currentModel.useContentTitle&&this.canUseContentTitle&&(this.currentModel.text=this.currentModel.contentLink.text),this.emitUpdate()},model:function(t){this.currentModel=t||this.getLinkDefaults(),this.initSelect2(10)}},methods:{emitUpdate:function(){this.$emit("update",this.currentModel)},selectLink:function(t){(this.currentModel.contentLink=t)?(this.currentModel.url=t.url,this.currentModel.type=t.type,this.currentModel.id=t.id,this.currentModel.useContentTitle?this.currentModel.text=t.text:this.currentModel.text||(this.currentModel.useContentTitle=!0)):(this.currentModel.type="Custom",this.currentModel.id=null,this.currentModel.useContentTitle=!1),this.emitUpdate()},initSelect2:function(t){var e=$(this.$refs.existingContentSelect),n=this.currentModel&&this.currentModel.contentLink?this.currentModel.contentLink:null;e.hasClass("select2-hidden-accessible")&&e.select2("destroy"),e.empty(),setTimeout(()=>{e.select2({theme:"bootstrap4",allowClear:!0,dropdownParent:this.$refs.dropdownContainer,minimumInputLength:2,placeholder:"Select existing content to link to",data:n?[n]:null,ajax:{url:"/manager/api/links/all",dataType:"json",delay:250,data:t=>({search:t.term}),processResults:t=>({results:t||[]})},templateResult:t=>t.id?$('<span><span class="badge badge-light">'+t.type+"</span> "+t.text+"</span>"):t.text,templateSelection:t=>t.id?$('<span><span class="badge badge-info">'+t.type+"</span> "+t.text+"</span>"):t.text}).on("select2:open",t=>{var e=$(t.currentTarget).data("select2").$dropdown.find(".select2-search__field").eq(0);0<e.length&&(e.attr("placeholder","Start typing to search..."),setTimeout(()=>{e[0].focus()},5))}).on("select2:select",t=>{t=t.params?t.params.data:null;this.selectLink(t)}).on("select2:clear",t=>{this.selectLink(null),setTimeout(()=>{$(t.currentTarget).select2("close")})})},t||0===t?t:10)},getLinkDefaults:function(){return{id:null,type:"Custom",url:null,text:null,contentLink:null,useContentTitle:!1,attributes:{class:null,target:null,rel:null}}}},template:'\n<div class="link-field-container">\n    <div class="form-group">\n        <label>Link Text</label>\n        <template v-if="canUseContentTitle">\n            <div class="input-group">\n                <input class="form-control" type="text" v-model="currentModel.text" :disabled="currentModel.useContentTitle">\n                <div class="input-group-append">\n                    <label class="input-group-text form-check">\n                        <input type="checkbox" class="form-check-input" v-model="currentModel.useContentTitle">\n                        Use {{currentModel.type.toLowerCase()}} title\n                    </label>\n                </div>\n            </div>\n        </template>\n        <template v-else>\n            <input class="form-control" type="text" v-model="currentModel.text">\n        </template>\n    </div>\n    <div class="form-group">\n        <label>Link URL</label>\n        <input class="form-control" type="text" v-model="currentModel.url" :disabled="currentModel.type != \'Custom\'">\n    </div>\n    <div class="form-group">\n        <select class="form-control" ref="existingContentSelect"></select>\n        <div ref="dropdownContainer" class="select2-dropdown-inline"></div>\n    </div>\n    <div class="row justify-content-end">\n        <div class="col-sm-12">\n            <div class="row">\n                <div class="col-auto">\n                    <div class="custom-control custom-checkbox">\n                        <input type="checkbox" class="custom-control-input" :id="\'target-blank-\' + uid" v-model="linkTargetBlank">\n                        <label class="custom-control-label" :for="\'target-blank-\' + uid">Open in a new tab</label>\n                    </div>\n                </div>\n                <div class="col-auto">\n                    <div class="custom-control custom-checkbox">\n                        <input type="checkbox" class="custom-control-input" :id="\'nofollow-\' + uid" v-model="linkNofollow">\n                        <label class="custom-control-label" :for="\'nofollow-\' + uid">No follow</label>\n                    </div>\n                </div>\n                <div class="col-auto">\n                    <div class="custom-control custom-checkbox">\n                        <input type="checkbox" class="custom-control-input" :id="\'noopener-\' + uid" v-model="linkNoopener">\n                        <label class="custom-control-label" :for="\'noopener-\' + uid">No opener</label>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n'}),piranha.navigation=piranha.navigation||{},piranha.navigation.linkmodal=new Vue({name:"Link Modal",data:function(){return{availableItemTypes:[]}},methods:{open:function(t,e){this.init(),this.$refs.modal.setAvailableItemTypes(this.availableItemTypes),this.$refs.modal.open(JSON.parse(JSON.stringify(e||{})),t)},init:function(){this._isMounted||($("#linkmodalwrap").remove(),$(document.body).append('<div id="linkmodalwrap"><link-modal ref="modal"></link-modal></div>'),this.$mount("#linkmodalwrap"))},setAvailableItemTypes:function(t){t&&(this.availableItemTypes=t)}}});